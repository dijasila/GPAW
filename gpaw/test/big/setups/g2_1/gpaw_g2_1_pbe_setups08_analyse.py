import os

import csv

import numpy as np

from ase.tasks.main import run
from ase.data.g2_1 import molecule_names
from ase.data.g2_1 import atom_names

ref = {'energy': {'NH3': -19.588423741682451, 'S2': -7.0374599433347456, 'SiH2_s3B1d': -8.7521819181818632, 'Li': -0.2932171611962624, 'CH3OH': -30.328806005140425, 'SiH4': -18.85156365550738, 'Si2H6': -30.84830722136503, 'PH3': -15.543082128313339, 'PH2': -10.774131836954925, 'HF': -8.0071581077321081, 'O2': -10.109238048006931, 'SiH3': -13.797270291762445, 'NH': -8.0955367379248031, 'Be': 0.00018138665503633115, 'SH2': -11.133147484166463, 'ClO': -5.8187854568587616, 'H2O2': -18.386865409761885, 'NO': -12.518863026905196, 'ClF': -4.2099460322068776, 'LiH': -3.725234110510276, 'HCO': -17.226457988661025, 'CH3': -18.150098838697005, 'CH4': -24.041071690354848, 'Cl2': -3.498741934107148, 'Na': -0.21821612530551093, 'HOCl': -11.006171952514402, 'SiH2_s1A1d': -9.469855070262625, 'SiO': -11.25416845838855, 'F2': -3.8074648332434609, 'P2': -8.9714893982282788, 'Si2': -5.2143242610247444, 'C': -1.3764973443170034, 'CH': -6.1595467803653978, 'CO': -14.945203611750681, 'CN': -13.007808092133478, 'F': -0.75010164011376756, 'H': -1.1155249621968188, 'LiF': -7.0076219540715039, 'O': -1.9797258786745671, 'N': -3.1481095932264807, 'Na2': -1.1983951662937913, 'P': -1.8706529379045491, 'Si': -0.85321994530222101, 'SO2': -17.037034701654303, 'NaCl': -4.6252792757116907, 'Li2': -1.4475891137691328, 'NH2': -13.556135033232398, 'CS': -10.183623910662602, 'C2H6': -40.510923404803187, 'N2': -16.827002200669821, 'C2H4': -31.987218139985195, 'HCN': -19.773494619552316, 'C2H2': -22.956940149008958, 'CH2_s3B1d': -12.023486162515159, 'CH3Cl': -22.377242708241578, 'BeH': -3.5117079665034181, 'CO2': -23.281326919814799, 'CH3SH': -27.577909233154053, 'OH': -7.837288525235774, 'Cl': -0.33003361621479316, 'S': -1.0310129290756995, 'N2H4': -30.410357624014669, 'H2O': -14.324339188362618, 'SO': -9.0871715678830594, 'CH2_s1A1d': -11.361968312405574, 'H2CO': -22.28157870054228, 'HCl': -6.0473421823419145}, 'ae': {'NH3': 13.093739261865514, 'S2': 4.9754340851833465, 'SiH2_s3B1d': 5.6679120484860039, 'CH3OH': 22.51048293336158, 'SiH4': 13.536243861417883, 'Si2H6': 22.448717557579673, 'PH3': 10.325854303818332, 'PH2': 6.6724289746567385, 'HF': 6.141531505421522, 'O2': 6.1497862906577971, 'SiH3': 9.5974754598697665, 'NH': 3.8319021825015032, 'SH2': 7.8710846306971254, 'ClO': 3.5090259619694013, 'H2O2': 12.196363728019113, 'NO': 7.3910275550041487, 'ClF': 3.1298107758783171, 'LiH': 2.3164919871171947, 'HCO': 12.754709803472636, 'CH3': 13.427026607789545, 'CH4': 18.20247449725057, 'Cl2': 2.8386747016775615, 'HOCl': 7.5808874954282226, 'SiH2_s1A1d': 6.3855852005667657, 'SiO': 8.4212226344117624, 'F2': 2.3072615530159259, 'P2': 5.2301835224191802, 'Si2': 3.5078843704203022, 'CH': 3.6675244738515755, 'CO': 11.588980388759111, 'CN': 8.4832011545899952, 'LiF': 5.9643031527614738, 'Na2': 0.76196291568276941, 'SO2': 12.04657001522947, 'NaCl': 4.0770295341913867, 'Li2': 0.861154791376608, 'NH2': 8.1769755156122788, 'CS': 7.7761136372698996, 'C2H6': 31.064778942988266, 'N2': 10.530783014216858, 'C2H4': 24.772123602563912, 'HCN': 14.133362719812013, 'C2H2': 17.972895535981312, 'CH2_s3B1d': 8.4159388938045172, 'CH3Cl': 17.324136861119324, 'BeH': 2.3963643909616357, 'CO2': 17.945377818148661, 'CH3SH': 20.708299110974075, 'OH': 4.7420376843643881, 'N2H4': 19.652038588774431, 'H2O': 10.113563385294412, 'SO': 6.0764327601327928, 'CH2_s1A1d': 7.7544210436949328, 'H2CO': 16.694305553157072, 'HCl': 4.6017836039303024}}

atoms, task = run('gpaw molecule g2-1 -t g2_1_pbe_setups08 --atomize -s')

prop2molecules = {'ae': molecule_names, 'energy': molecule_names + atom_names}
prop2index = {'ae': 4, 'energy': 0}
prop2prec = {'ae': 0.02, 'energy': 0.02}

calc = {}

for p in ['ae', 'energy']:
    calc[p] = {}
    for m in prop2molecules[p]:
        try:
            calc[p][m] = task.results[m][prop2index[p]]
        except KeyError:
            calc[m] = None
            print 'Missing: ' + m + ' for property ' + p
            pass

    skeys = ref[p].keys()
    skeys.sort()
    for k in skeys:
        assert calc[p][k] is not None, 'Missing: ' + k + ' for property ' + p
        diff = calc[p][k] - ref[p][k]
        assert abs(diff) < prop2prec[p], 'Error: ' + k + ' ' + str(diff) + ' for property ' + p

    outfilename = 'gpaw_g2_1_pbe_setups08_%s.csv' % p

    d = []
    for k in skeys:
        d.append([k, calc[p][k]])
    csvwriter = csv.writer(open(outfilename, 'wb'))
    for row in d:
        csvwriter.writerow(row)
