import pytest
import numpy as np
from ase import Atoms
from gpaw import GPAW
from gpaw.test import only_on_master
from gpaw.mpi import world
from . import check_txt_data
from ase.parallel import paropen
from gpaw.lcaotddft import LCAOTDDFT
from gpaw.lcaotddft.qed import RRemission
from gpaw.lcaotddft.dipolemomentwriter import DipoleMomentWriter
from gpaw.tddft.spectrum import read_td_file_data


@pytest.fixture()
@only_on_master(world)
def write_inputs():
    for label in 'xyz':
        with paropen(f'dm_ensemblebare_{label}.dat', 'w') as fd:
            fd.write('''
# DipoleMomentWriter[version=1](center=False, density='comp')
#            time            norm                    dmx                    dmy                    dmz
# Start; Time = 0.00000000
          0.00000000      -4.92017275e-16     2.055079955338e-14     2.275267093410e-14     9.816676572374e-15
# Kick = [    0.000000000000e+00,     0.000000000000e+00,     1.000000000000e-05]; Time = 0.00000000
          0.00000000      -2.56261929e-15     5.578074164489e-14     4.477138474129e-14     4.724849004460e-14
          0.41341373       3.79876430e-16    -1.137633546705e-14    -2.752339225899e-14     9.139522195897e-06
          0.82682747       1.82844350e-15    -3.229411358388e-14    -2.899130651281e-14     1.822151056685e-05
          1.24024120       2.30257796e-16     2.568849944173e-15    -1.467914253813e-15     2.719465212110e-05
          1.65365493      -1.09563085e-16     1.834892817266e-14    -3.669785634532e-16     3.601753782894e-05
          2.06706867       1.33270742e-15    -2.422058518791e-14    -3.045922076662e-14     4.466069760315e-05
          2.48048240       8.37044574e-16    -1.724799248230e-14    -2.642245656863e-14     5.310709155553e-05
          2.89389613       2.93431494e-17     5.504678451798e-15     2.568849944173e-15     6.135047097171e-05
          3.30730987       3.77197226e-16     1.100935690360e-15    -0.000000000000e+00     6.939195199957e-05
          3.72072360      -1.63710169e-16     1.431216397468e-14     6.238635578705e-15     7.723547141815e-05
          4.13413733      -4.03410565e-16     2.055079955338e-14     4.403742761439e-15     8.488299714725e-05
          4.54755107      -2.41349366e-15     6.752405567539e-14     7.596456263482e-14     9.233040644308e-05
          4.96096480       1.00069275e-15    -2.568849944173e-14    -3.449598496460e-14     9.956481323431e-05
          5.37437853      -2.31624289e-15     6.642311998503e-14     6.312031291396e-14     1.065638527118e-04
          5.78779227      -3.55273735e-15     8.697391953842e-14     8.293715534043e-14     1.132970565629e-04
          6.20120600       1.69532988e-15    -3.192713502043e-14    -3.229411358388e-14     1.197290637407e-04
          6.61461974      -2.82658143e-15     6.091844153324e-14     7.706549832518e-14     1.258240590975e-04
          7.02803347       2.57310750e-15    -4.697325612201e-14    -4.954210606619e-14     1.315505996358e-04
          7.44144720      -9.51935488e-17     7.339571269065e-16     1.137633546705e-14     1.368859163511e-04
          7.85486094       2.68573513e-15    -5.174397744691e-14    -4.844117037583e-14     1.418188643634e-04
          8.26827467       1.00204830e-15    -2.275267093410e-14    -2.568849944173e-15     1.463509522156e-04
          8.68168840       2.04459745e-15    -4.660627755856e-14    -3.743181347223e-14     1.504952279150e-04
          9.09510214      -4.46448289e-16     1.064237834014e-14     1.871590673611e-14     1.542732031233e-04
          9.50851587      -2.70445314e-15     6.789103423885e-14     6.752405567539e-14     1.577103565344e-04
          9.92192960       2.74605367e-15    -5.798261302561e-14    -6.679009854849e-14     1.608310263102e-04
    '''.strip())  # noqa: E501


def test_embeddingrr_dyadic(in_tmp_dir, write_inputs):
    """
    Testing if the dyadic is calculated correctly.
    Note, that this requires to use "extrapolate" for the interp1d function
    """
    dt, nt = 0.1, 1000
    rremission = RRemission(1e1, [0, 0, 1],
                            [2.98, 3, 0.01, 0, 0, 3000], [1, 1, 0, 0, 0])
    dyadic_out_very_good, _ = rremission.dyadicGt(dt, nt)
    # Test that the first 30 elements of the dyadic agree with the reference
    dyadic_ref = [-0.26509844 + 1.07477307e-15j, -0.2646285 + 5.76719985e-16j,
                  -0.26482334 + 2.78241075e-16j, -0.26470851 - 2.48979644e-16j,
                  -0.26446162 - 4.63244966e-16j, -0.26435981 + 5.00200484e-16j,
                  -0.26407471 + 1.93115042e-16j, -0.26387885 - 1.57573539e-16j,
                  -0.26355268 + 7.27542009e-16j, -0.26327364 + 4.10345111e-16j,
                  -0.26289701 + 2.23836927e-16j, -0.26254291 - 1.52533693e-16j,
                  -0.26211057 - 4.12098469e-16j, -0.26168581 - 2.42895168e-16j,
                  -0.26119494 - 4.52349475e-16j, -0.26070207 + 1.01101853e-16j,
                  -0.26015115 + 4.87958740e-16j, -0.25959181 + 3.62597864e-16j,
                  -0.25898007 - 4.87213351e-16j, -0.25835544 + 2.55465137e-16j,
                  -0.25768254 + 5.68664039e-16j, -0.25699357 - 4.40321607e-16j,
                  -0.25625944 - 2.43674438e-16j, -0.2555069 + 8.38901431e-16j,
                  -0.25471166 + 5.84927072e-16j, -0.25389627 - 5.16080234e-16j,
                  -0.25304015 - 7.72222997e-16j, -0.25216259 - 3.98986399e-16j,
                  -0.25124595 + 4.53738609e-16j, -0.25030692 + 4.82469967e-16j]
    assert np.allclose(dyadic_out_very_good[:30, -1], dyadic_ref)

    """
    Test if doubling resolution = half total time for dyadic
    """
    dt, nt = 0.1, 500
    rremission = RRemission(1e1, [0, 0, 1],
                            [2.98, 3, 0.01, 0, 0, 6000], [1, 1, 0, 0, 0])
    dyadic_out_very_good_split, _ = rremission.dyadicGt(dt, nt)
    assert np.allclose(dyadic_out_very_good_split[:30, -1], dyadic_ref)


def test_cavityrr(in_tmp_dir, write_inputs):
    cross_section = 1e0
    dt, nt = 5, 100
    """
    Perform a short TD run to check if the full function remained consistent
    """
    d = 1.104  # N2 bondlength
    atoms = Atoms('Na2',
                  positions=[[0, 0, d / 2], [0, 0, -d / 2]],
                  cell=[10, 10, 10])
    atoms.center()
    calc = GPAW(mode='lcao', h=0.4, basis='dzp',
                setups={'Na': '1'},
                convergence={'density': 1e-12})
    atoms.calc = calc
    atoms.get_potential_energy()
    calc.write('gs.gpw', mode='all')
    td_calc = LCAOTDDFT('gs.gpw',
                        rremission=RRemission(cross_section, [0, 0, 1],
                                              [2.98, 3, 0.01, 0, 0, 30000]),
                        propagator={'name': 'scpc', 'tolerance': 1e-0})
    DipoleMomentWriter(td_calc, 'dm_cav.dat')
    td_calc.absorption_kick([0.0, 0.0, 1e-5])
    td_calc.propagate(dt, int(nt * 0.5))

    td_calc.write('td_cavsplit0.gpw', mode='all')

    td_calc_restart = LCAOTDDFT('td_cavsplit0.gpw')
    DipoleMomentWriter(td_calc_restart, 'dm_cav.dat')
    td_calc_restart.propagate(dt, int(nt * 0.5))

    with paropen('dm_cav_ref.dat', 'w') as fd:
        fd.write('''
# DipoleMomentWriter[version=1](center=False, density='comp')
#            time            norm                    dmx                    dmy                    dmz
# Start; Time = 0.00000000
          0.00000000       1.44357020e-16    -1.055049940181e-15    -1.183029494090e-15    -2.047822887409e-14
# Kick = [    0.000000000000e+00,     0.000000000000e+00,     1.000000000000e-05]; Time = 0.00000000
          0.00000000      -4.80519666e-16     2.313133545827e-15    -3.058840526496e-16    -2.173477055740e-14
          0.20670687       9.24387732e-16    -9.558834971724e-15    -6.311379837286e-15     4.740315654371e-06
          0.41341373       6.21330611e-16    -2.499456107053e-15    -1.260792388128e-15     9.469789378885e-06
          0.62012060      -3.42169803e-17    -5.662188860150e-16     1.467326634032e-15     1.417715766848e-05
          0.82682747       2.11891230e-16    -1.617976613640e-15    -4.198946236631e-15     1.885124717352e-05
          1.03353433       1.27923343e-15    -6.652853124399e-15    -9.386848120867e-15     2.348147810977e-05
          1.24024120       1.28984519e-15    -9.697774676292e-15    -1.093652174237e-14     2.805804134859e-05
          1.44694807      -7.58965966e-17    -2.182028473669e-15    -2.164067162131e-15     3.257205642345e-05
          1.65365493       3.46377459e-16    -1.406899947882e-15    -9.797457871652e-16     3.701570672777e-05
          1.86036180       8.81464343e-16    -3.680610290193e-15    -3.002914586625e-15     4.138234851823e-05
          2.06706867       3.77048364e-16     4.297795960457e-16     5.557588182745e-16     4.566659110378e-05
          2.27377553       1.85772004e-17     1.433987772707e-15     2.956240180771e-15     4.986434627522e-05
          2.48048240       3.10466831e-16     1.649440164015e-16    -1.142772819041e-15     5.397284586570e-05
          2.68718927      -1.15565006e-16     3.808173108334e-15     5.459446909722e-15     5.799062720381e-05
          2.89389613      -2.82495177e-16     2.297505954581e-15     9.251117281701e-16     6.191748665451e-05
          3.10060300      -1.34353912e-16     3.078343760371e-15     1.824094123777e-15     6.575440279524e-05
          3.30730987      -5.00658198e-16     2.987745404722e-15     1.532879170110e-15     6.950343112809e-05
          3.51401673       5.13228241e-16    -2.029461509535e-15    -5.906937775846e-15     7.316757301586e-05
          3.72072360      -7.24828375e-17    -2.967158657855e-16    -9.707859681843e-16     7.675062240085e-05
          3.92743047       6.26252775e-16    -4.817798849961e-15    -5.480575413087e-15     8.025699406218e-05
          4.13413733      -3.98774691e-16     4.606180427706e-15     5.476158013961e-15     8.369153794630e-05
          4.34084420       2.49839529e-16    -4.707447218978e-15    -6.456695599083e-15     8.705934425913e-05
          4.54755107       6.28766783e-16    -6.854428214680e-15    -4.584176779232e-15     9.036554439941e-05
          4.75425793       4.33044598e-16     3.056506806203e-15     3.238078579690e-15     9.361511268123e-05
          4.96096480       3.83081985e-16    -6.998243727718e-16    -2.497122386760e-15     9.681267395442e-05
          5.16767167       2.75588269e-16    -2.663066569001e-15    -2.005790917994e-15     9.996232217351e-05
          5.37437853       3.18458732e-16     1.587513229105e-15    -7.747117900213e-17     1.030674543102e-04
          5.58108540       7.07786043e-16    -1.000357538179e-14    -9.900599973873e-15     1.061306240453e-04
          5.78779227       3.89750723e-16    -5.574674349174e-15    -6.865054976728e-15     1.091534188913e-04
          5.99449913       4.56491036e-16    -8.087007591413e-15    -3.000330824872e-15     1.121363638713e-04
          6.20120600       1.13749627e-15    -9.338506771947e-15    -8.159269573333e-15     1.150788542893e-04
          6.40791287       1.62881294e-16    -5.369640352030e-15    -1.041126798221e-14     1.179791193374e-04
          6.61461974      -3.58471164e-16     1.223869599212e-15    -1.439905420593e-15     1.208342173717e-04
          6.82132660       1.30463815e-16    -3.964449020792e-15    -1.034546540467e-15     1.236400632073e-04
          7.02803347       2.71380613e-16     3.413566010986e-15     1.179820628687e-15     1.263914866136e-04
          7.23474034       6.54700767e-17    -6.435775463602e-15    -3.981035104300e-15     1.290823206249e-04
          7.44144720       5.76025529e-16    -6.234117026167e-15    -4.748662386290e-15     1.317055174725e-04
          7.64815407       1.94769509e-17    -2.052590344578e-15    -4.174442173557e-15     1.342532892596e-04
          7.85486094      -6.20192691e-16     2.842179601465e-15     4.751871251693e-15     1.367172697938e-04
          8.06156780      -7.37213176e-16     5.690360197969e-15     8.853593033987e-15     1.390886935737e-04
          8.26827467       2.91810241e-16    -4.058047873959e-15    -3.704864311806e-15     1.413585873664e-04
          8.47498154      -1.82596414e-18    -1.698781678775e-15     1.995830933174e-15     1.435179697253e-04
          8.68168840       8.08955042e-16    -7.350635491915e-15    -2.345263873428e-15     1.455580530571e-04
          8.88839527       3.06365027e-16    -5.020624147542e-15    -8.128264432302e-15     1.474704436719e-04
          9.09510214       3.05280034e-16    -7.040334040140e-16     4.953571362704e-15     1.492473342485e-04
          9.30180900       2.29330511e-16    -3.197613536758e-15    -3.717366384802e-15     1.508816842133e-04
          9.50851587       2.58413621e-16    -7.923647170924e-15    -1.227157644410e-14     1.523673834152e-04
          9.71522274       9.63765046e-16    -1.454699540305e-14    -1.458304304686e-14     1.536993947005e-04
          9.92192960       2.87576121e-16     3.411815720766e-16    -2.357932640731e-15     1.548738722346e-04
         10.12863647       3.78980181e-16    -1.854265793276e-15    -9.817461188446e-16     1.558882520722e-04
         10.33534334       6.22706699e-16    -5.711530374910e-15    -7.707486328814e-15     1.567413130762e-04
# Start; Time = 10.33534334
         10.33534334      -3.14912657e-17     3.829801694618e-17     1.157191876563e-15     1.567413130808e-04
         10.54205020       1.03611557e-15    -9.448566687894e-15    -1.116843519646e-14     1.574332063881e-04
         10.74875707       3.59106282e-16    -3.312257546137e-15    -4.292378395492e-15     1.579654527051e-04
         10.95546394      -4.29180963e-16     3.351347361039e-15     5.004454799800e-15     1.583409074529e-04
         11.16217080       7.56531347e-16    -9.982196836964e-15    -8.658644042393e-15     1.585636946691e-04
         11.36887767       8.58600096e-16    -8.373971840261e-15    -2.142105187234e-15     1.586391112520e-04
         11.57558454       3.39814573e-16    -6.100303171527e-15    -4.481034677010e-15     1.585735037853e-04
         11.78229140       8.18772907e-16    -7.907519496759e-15    -9.409143484378e-15     1.583741212503e-04
         11.98899827       3.27562089e-16    -4.818548974341e-15     7.948818011224e-16     1.580489470653e-04
         12.19570514       2.24805296e-16    -2.157732778479e-15    -4.553921762580e-15     1.576065147434e-04
         12.40241200       2.06625044e-16    -7.132057582358e-15    -6.605136879129e-15     1.570557117117e-04
         12.60911887       1.42022962e-15    -1.338913674926e-14    -1.595089485341e-14     1.564055762254e-04
         12.81582574      -1.07041194e-15     5.706862934325e-15     7.791458585774e-15     1.556650924149e-04
         13.02253260       9.86020638e-17    -6.583925028611e-15    -7.307753381536e-15     1.548429884289e-04
         13.22923947       7.02308151e-16    -1.138913845842e-14    -1.192639420866e-14     1.539475431155e-04
         13.43594634       9.00729588e-16    -9.048750393463e-15    -9.241240644034e-15     1.529864054626e-04
         13.64265320       4.30583516e-16    -5.649270051387e-16    -4.309297867614e-15     1.519664318027e-04
         13.84936007      -7.90986496e-17     4.089428077181e-15     7.574589292860e-16     1.508935445175e-04
         14.05606694       5.15027741e-16    -6.345218781530e-15    -4.836593633033e-15     1.497726158492e-04
         14.26277380       6.50995912e-17     4.847887172306e-15     3.865932685578e-15     1.486073797902e-04
         14.46948067       3.20840424e-16    -4.501329708841e-15    -4.964739881248e-15     1.474003738723e-04
         14.67618754      -4.92216421e-17    -2.441071426159e-15     2.692779829156e-15     1.461529127449e-04
         14.88289440       2.41503605e-16    -8.146517458877e-15    -5.416481452191e-15     1.448650936783e-04
         15.08960127      -1.40440460e-16    -3.482535780350e-15    -1.832928922028e-15     1.435358341700e-04
         15.29630814       7.18477196e-17     2.556840622107e-15     2.876226913593e-15     1.421629403961e-04
         15.50301500       1.71667093e-16    -3.740911955613e-15    -8.209694601086e-16     1.407432048716e-04
         15.70972187       9.79854701e-16    -6.375807186795e-15    -9.407768256348e-15     1.392725307379e-04
         15.91642874       4.24735138e-16    -4.925608392768e-15    -4.797962227473e-15     1.377460795608e-04
         16.12313560       1.64416163e-16    -3.607181448126e-15    -4.531584725493e-16     1.361584387294e-04
         16.32984247       7.40388765e-16    -7.353010885784e-15    -1.085354965125e-14     1.345038043511e-04
         16.53654934       1.00118408e-15    -1.000053321069e-14    -5.903853931174e-15     1.327761749430e-04
         16.74325620       7.76246467e-16    -4.706322032408e-15    -4.918857273350e-15     1.309695508323e-04
         16.94996307       2.44149930e-16    -1.015868443410e-14    -7.193067698581e-15     1.290781344685e-04
         17.15666994       3.25365640e-16    -1.763584090474e-15    -2.198322842142e-15     1.270965263255e-04
         17.36337680      -3.41587611e-16     1.421068963944e-17     1.352224215310e-15     1.250199115322e-04
         17.57008367       6.58643791e-16    -3.438070074059e-15    -2.212950267548e-15     1.228442324339e-04
         17.77679054       3.72681928e-16    -5.440068696578e-15    -2.755456888446e-15     1.205663427911e-04
         17.98349740       1.00920244e-15    -6.273790271143e-15    -6.486783921428e-15     1.181841394942e-04
         18.19020427       1.04095834e-15    -5.292919297408e-15    -7.852010292654e-15     1.156966686602e-04
         18.39691114       1.00634441e-15    -9.235531364032e-15    -1.112163576987e-14     1.131042032611e-04
         18.60361800       8.46771024e-16    -8.778247207394e-15    -9.206484881103e-15     1.104082903155e-04
         18.81032487       2.47007961e-16    -3.255123072542e-15    -6.972364436615e-15     1.076117664606e-04
         19.01703174       1.35277480e-15    -1.165809972216e-14    -1.231804248207e-14     1.047187413678e-04
         19.22373861       7.67143110e-16    -6.731657857854e-15    -9.745532595139e-15     1.017345496291e-04
         19.43044547       8.72519765e-16    -1.052345325056e-14    -1.116776841923e-14     9.866567188066e-05
         19.63715234      -1.08134126e-15     1.106529309423e-14     1.061930247687e-14     9.551962758114e-05
         19.84385921       6.19769279e-16     1.792588899826e-15    -7.816712773227e-16     9.230484172343e-05
         20.05056607       7.19244630e-16    -9.414436028613e-15    -7.714987572612e-15     8.903048916228e-05
         20.25727294      -2.81860059e-16    -1.041130965578e-15     2.725201871794e-15     8.570632005169e-05
         20.46397981       8.04085804e-16    -2.874476623373e-15    -2.010041622813e-15     8.234247107498e-05
         20.67068667       5.41173431e-16    -1.083554666613e-15     2.161691768262e-15     7.894926715549e-05
'''.strip())  # noqa: E501

    check_txt_data('dm_cav.dat', 'dm_cav_ref.dat', atol=1e-8)

    """
    Checking explicitly the restart. Can be removed later.
    """

    td_calc = LCAOTDDFT('gs.gpw',
                        rremission=RRemission(cross_section, [0, 0, 1],
                                              [2.98, 3, 0.01, 0, 0, 15000]),
                        propagator={'name': 'scpc', 'tolerance': 1e-0})
    DipoleMomentWriter(td_calc, 'dm_cav_long.dat')
    td_calc.absorption_kick([0.0, 0.0, 1e-5])
    td_calc.propagate(dt, nt)

    dip_cav_full = read_td_file_data('dm_cav_long.dat')[1][-40:]
    dip_cav_restart = read_td_file_data('dm_cav.dat')[1][-40:]
    assert np.allclose(dip_cav_full, dip_cav_restart)


def test_embeddingrr(in_tmp_dir, write_inputs):
    cross_section = 1e0
    dt, nt = 5, 100
    """
    Perform a short TD run to check if the full function remained consistent
    """
    d = 1.104  # N2 bondlength
    atoms = Atoms('Na2',
                  positions=[[0, 0, d / 2], [0, 0, -d / 2]],
                  cell=[10, 10, 10])
    atoms.center()
    calc = GPAW(mode='lcao', h=0.4, basis='dzp',
                setups={'Na': '1'},
                convergence={'density': 1e-12})
    atoms.calc = calc
    atoms.get_potential_energy()
    calc.write('gs.gpw', mode='all')
    td_calc = LCAOTDDFT('gs.gpw',
                        rremission=RRemission(cross_section, [0, 0, 1],
                                              [2.98, 3, 0.01, 0, 0, 30000],
                                              [1, 1, 0, 0, 0]),
                        propagator={'name': 'scpc', 'tolerance': 1e-0})
    DipoleMomentWriter(td_calc, 'dm.dat')
    td_calc.absorption_kick([0.0, 0.0, 1e-5])
    td_calc.propagate(dt, nt)

    with paropen('dm_ref.dat', 'w') as fd:
        fd.write('''
# DipoleMomentWriter[version=1](center=False, density='comp')
#            time            norm                    dmx                    dmy                    dmz
# Start; Time = 0.00000000
          0.00000000       1.44357020e-16    -1.055049940181e-15    -1.183029494090e-15    -2.047822887409e-14
# Kick = [    0.000000000000e+00,     0.000000000000e+00,     1.000000000000e-05]; Time = 0.00000000
          0.00000000      -4.80519666e-16     2.313133545827e-15    -3.058840526496e-16    -2.173477055740e-14
          0.20670687      -6.16249667e-16     5.765706024562e-15     4.729325846722e-15     4.740306619049e-06
          0.41341373       4.32303627e-16     8.674354980792e-16     7.084508031394e-16     9.469762275649e-06
          0.62012060       4.33759105e-16    -3.397896746163e-15    -3.936777765892e-15     1.417714914178e-05
          0.82682747      -1.88418329e-17     1.061467670986e-15    -2.336929158097e-15     1.885136691020e-05
          1.03353433       4.21056746e-16    -2.812091279120e-15    -4.832592969674e-15     2.348190788320e-05
          1.24024120       3.18829217e-16    -5.012497800095e-15    -1.102641164722e-15     2.805903311993e-05
          1.44694807      -5.16403830e-16     5.993660488866e-15     5.403062560508e-15     3.257393023521e-05
          1.65365493       3.44525032e-16    -3.531418885767e-16    -9.002742764836e-16     3.701884822865e-05
          1.86036180       8.23906778e-16    -7.314837889568e-15    -3.951030129109e-15     4.138720640632e-05
          2.06706867       8.08743336e-16    -4.631017879392e-15    -4.386143942966e-15     4.567367427895e-05
          2.27377553       7.10855780e-16    -5.165689867879e-15    -4.720616069201e-15     4.987422094300e-05
          2.48048240      -5.01478558e-17    -1.990830103975e-15     6.977823675157e-16     5.398613252118e-05
          2.68718927       4.97509071e-17    -2.149106348112e-15    -3.235119755748e-15     5.800799750311e-05
          2.89389613       3.10863780e-16    -5.104888119539e-15    -6.769497465457e-15     6.193966041071e-05
          3.10060300       2.89799034e-16    -3.794254133731e-15    -1.819051621002e-15     6.578214492022e-05
          3.30730987       3.41905170e-17     3.294087866715e-15     4.487327387085e-15     6.953754863762e-05
          3.51401673       1.13950748e-16     1.585762938886e-15    -5.737618033896e-16     7.320891221993e-05
          3.72072360      -2.78896176e-16     5.296128162810e-15     2.440321301779e-15     7.680006617670e-05
          3.92743047       5.85975711e-16    -5.487159838198e-15    -5.319673733621e-15     8.031545926407e-05
          4.13413733       5.03172206e-16    -8.531414612865e-15    -9.792998798949e-15     8.375997304559e-05
          4.34084420       1.17338044e-16     4.719949291975e-16     2.970909279753e-15     8.713872713286e-05
          4.54755107       6.93284183e-16    -4.734034960884e-15    -2.117142714817e-15     9.045688023211e-05
          4.75425793       6.75527343e-16    -5.089427222600e-15    -5.373474321083e-15     9.371943207342e-05
          4.96096480       9.10944402e-16    -3.402230798135e-15    -5.104137995160e-15     9.693103112693e-05
          5.16767167       5.42364277e-16    -4.634185071218e-15    -3.991703539924e-15     1.000957932028e-04
          5.37437853       7.00879135e-16    -4.968323808840e-15    -3.583635877316e-15     1.032171354379e-04
          5.58108540       3.20178843e-16    -9.342382414576e-16    -2.896313577541e-16     1.062976299337e-04
          5.78779227       1.16692340e-15    -9.667603006794e-15    -8.453735065979e-15     1.093388807432e-04
          5.99449913      -4.56676279e-16     2.613516686358e-15    -1.758208199085e-16     1.123414275543e-04
          6.20120600       1.19418055e-15    -9.606134481227e-15    -9.953858804839e-15     1.153046781252e-04
          6.40791287      -4.36220188e-16     4.275750638406e-15     7.720030075387e-16     1.182268718623e-04
          6.61461974       1.38302229e-15    -5.770415138724e-15    -6.778248916555e-15     1.211050747346e-04
          6.82132660       1.04095834e-15    -9.173312714086e-15    -1.009638243700e-14     1.239352064733e-04
          7.02803347       5.21855260e-17    -9.288081744194e-15    -1.092685347259e-14     1.267120987234e-04
          7.23474034       6.26093995e-16    -6.563171587437e-16     1.424361176500e-15     1.294295831404e-04
          7.44144720       3.04777232e-16    -1.493080904405e-15     2.312258400717e-15     1.320806071558e-04
          7.64815407       8.24541895e-16    -5.982491970322e-15    -2.545588756410e-15     1.346573743343e-04
          7.85486094       3.66383675e-16    -7.870846749302e-15    -6.834299877156e-15     1.371515060079e-04
          8.06156780      -5.30588132e-16     4.605722018363e-15     4.349012786166e-15     1.395542199951e-04
          8.26827467      -1.88524182e-16     1.312134234568e-15     4.265957347892e-15     1.418565220081e-04
          8.47498154       1.54016106e-17    -5.165064764230e-15    -5.526999777480e-15     1.440494048373e-04
          8.68168840       1.24843021e-15    -1.270318967752e-14    -8.104927229375e-15     1.461240503414e-04
          8.88839527       2.05222492e-16    -2.998622208229e-15    -2.773418199984e-15     1.480720292158e-04
          9.09510214       5.58374542e-18    -3.707156358522e-15    -1.103349615525e-15     1.498854932590e-04
          9.30180900      -2.42244576e-16    -2.788837423347e-15    -2.404023616512e-15     1.515573557086e-04
          9.50851587       4.14123375e-16    -5.058255387262e-15    -7.621680434480e-15     1.530814546130e-04
          9.71522274       4.59904795e-16     1.300215591644e-16    -7.166188241638e-16     1.544526955290e-04
          9.92192960       9.09488923e-16    -6.673023135500e-15    -4.644353423922e-15     1.556671695509e-04
         10.12863647       1.68007225e-15    -1.764650934036e-14    -1.682037235675e-14     1.567222440405e-04
         10.33534334      -1.35438906e-16     1.100140750122e-15     2.110058206786e-15     1.576166234927e-04
         10.54205020       4.45482325e-16    -6.162563495050e-15    -4.853179716542e-15     1.583503789755e-04
         10.74875707       2.08451008e-16    -3.104431419357e-15     1.932403749504e-16     1.589249456834e-04
         10.95546394      -5.83302923e-16     6.097010958971e-15     6.627432242639e-15     1.593430881224e-04
         11.16217080       1.20434244e-16    -2.479244422375e-15    -1.069260629821e-15     1.596088342120e-04
         11.36887767       5.09205827e-16    -9.703275588411e-15    -8.755618455270e-15     1.597273797638e-04
         11.57558454      -1.36285730e-17    -7.551627152123e-15    -3.796921242637e-15     1.597049655944e-04
         11.78229140       1.55947923e-16    -6.339842890141e-15    -4.141353353693e-15     1.595487304675e-04
         11.98899827       4.87929375e-16    -6.299086132172e-15    -8.554793489368e-15     1.592665435148e-04
         12.19570514      -2.41106657e-16     3.223951237204e-15     5.127100135897e-15     1.588668202371e-04
         12.40241200      -7.41764854e-17    -4.474366904745e-15    -3.033836380503e-17     1.583583266799e-04
         12.60911887      -4.31853752e-16     2.153815462274e-15    -4.404897052461e-17     1.577499767594e-04
         12.81582574      -9.48972090e-17    -8.975654940010e-16    -2.168442887680e-15     1.570506276387e-04
         13.02253260       8.07102615e-16    -7.571797163224e-15    -8.425146992394e-15     1.562688784352e-04
         13.22923947       3.40978956e-16    -4.469366075547e-15    -3.440403794352e-15     1.554128771246e-04
         13.43594634       1.07665726e-15    -1.429236984969e-14    -1.725498608769e-14     1.544901404286e-04
         13.64265320      -2.94033154e-16     6.789875844441e-16    -1.223286169138e-15     1.535073914929e-04
         13.84936007       7.91039423e-16    -3.136978482725e-15    -3.047588660799e-15     1.524704187786e-04
         14.05606694       2.20015448e-16    -8.497242280007e-17    -2.793546537509e-15     1.513839604376e-04
         14.26277380       1.06170553e-16     4.608722515882e-15     2.171068323009e-15     1.502516162911e-04
         14.46948067       1.03788860e-16     1.297340114855e-15     1.334512945231e-15     1.490757901092e-04
         14.67618754       1.36497436e-15    -9.770453393979e-15    -9.356509757062e-15     1.478576632828e-04
         14.88289440       8.00804362e-16    -8.073171963964e-15    -6.321339822106e-15     1.465972007145e-04
         15.08960127       7.73441363e-16    -4.301629929509e-15    -2.228786226677e-15     1.452931884922e-04
         15.29630814      -1.02481576e-15     9.452609024829e-15     1.488013397483e-14     1.439433025860e-04
         15.50301500       8.57938515e-17    -1.086430143403e-16     1.034921602657e-15     1.425442065909e-04
         15.70972187       5.32784581e-16    -3.093221227237e-15    -2.611266313219e-16     1.410916762099e-04
         15.91642874       8.02577399e-16    -5.656687948032e-15    -8.698525655252e-15     1.395807470648e-04
         16.12313560       9.30791838e-16    -6.194068719001e-15    -4.374141952889e-15     1.380058822111e-04
         16.32984247       4.64774033e-16    -8.819379027553e-15    -7.831715260823e-15     1.363611550742e-04
         16.53654934      -2.76964358e-16    -8.486823885844e-16     1.394606242768e-15     1.346404431422e-04
         16.74325620       5.12328490e-16    -4.953738057011e-15    -6.787417103419e-15     1.328376274395e-04
         16.94996307       3.70009140e-16    -1.450157120450e-15     1.450698876946e-15     1.309467929017e-04
         17.15666994       5.19182472e-16    -1.428570207742e-16     1.584221016550e-15     1.289624242474e-04
         17.36337680       1.77833030e-17    -6.443568422436e-16    -1.919568287895e-15     1.268795926970e-04
         17.57008367       7.16598305e-16    -1.180899974322e-14    -1.095685844778e-14     1.246941285857e-04
         17.77679054      -8.27664559e-16     8.494325129642e-15     9.742282056160e-15     1.224027756579e-04
         17.98349740       5.91400677e-16    -1.446156457091e-15    -6.951736016171e-15     1.200033228232e-04
         18.19020427       1.72222821e-16    -4.204988905246e-15    -1.522419102370e-15     1.174947104797e-04
         18.39691114       8.59235214e-16    -1.953032169949e-15    -1.714992700094e-15     1.148771081959e-04
         18.60361800       1.69179547e-16    -6.175148915200e-15    -4.463073365472e-15     1.121519621712e-04
         18.81032487      -6.90690785e-17     1.481037240751e-15     1.128895518014e-15     1.093220109445e-04
         19.01703174      -7.77225607e-17    -3.248163585241e-15    -6.683733244701e-15     1.063912691493e-04
         19.22373861       4.07560490e-16    -7.973863830794e-15    -5.819881674214e-15     1.033649795536e-04
         19.43044547       2.23614449e-16     3.509873646636e-15    -1.541922336245e-17     1.002495346388e-04
         19.63715234       1.28770167e-16    -3.207073438659e-15    -1.686112911472e-15     9.705236955032e-05
         19.84385921       8.48279429e-16    -1.092514485594e-14    -8.972112685994e-15     9.378182931120e-05
         20.05056607       2.78922639e-16    -1.871685348318e-15    -2.917567101635e-16     9.044701340262e-05
         20.25727294       7.67645911e-16    -3.021292633930e-15    -3.635561153828e-15     8.705760160312e-05
         20.46397981      -1.43219101e-16    -5.292544235218e-16    -2.440571343239e-15     8.362366568447e-05
         20.67068667       3.77312997e-16    -4.596262116462e-15    -5.060505760402e-15     8.015547139764e-05
'''.strip())  # noqa: E501

    check_txt_data('dm.dat', 'dm_ref.dat', atol=1e-8)

    """
    Perform a short run and a subsequent restart, using the same dyadic.
    Same result as the longer run above?
    """

    td_calc = LCAOTDDFT('gs.gpw',
                        rremission=RRemission(cross_section, [0, 0, 1],
                                              [2.98, 3, 0.01, 0, 0, 60000],
                                              [1, 1, 0, 0, 0]),
                        propagator={'name': 'scpc', 'tolerance': 1e-0})
    DipoleMomentWriter(td_calc, 'dm_split.dat')
    td_calc.absorption_kick([0.0, 0.0, 1e-5])
    td_calc.propagate(dt, int(nt * 0.5))
    td_calc.write('td_split0.gpw', mode='all')

    td_calc_restart = LCAOTDDFT('td_split0.gpw')
    DipoleMomentWriter(td_calc_restart, 'dm_split.dat')
    td_calc_restart.propagate(dt, int(nt * 0.5))

    """
    Compare only the last 40 elements because the restart adds
    an additional step that is not properly removed.
    """
    dipole_full = read_td_file_data('dm.dat',
                                    remove_duplicates=True)[1][-40:]
    dipole_restart = read_td_file_data('dm_split.dat',
                                       remove_duplicates=True)[1][-40:]
    assert np.allclose(dipole_full, dipole_restart)
