import pytest
import numpy as np
from ase import Atoms
from gpaw import GPAW
from gpaw.test import only_on_master
from gpaw.mpi import world
from . import check_txt_data
from ase.parallel import paropen
from gpaw.lcaotddft import LCAOTDDFT
from gpaw.lcaotddft.qed import RRemission
from gpaw.lcaotddft.dipolemomentwriter import DipoleMomentWriter


@pytest.fixture()
@only_on_master(world)
def write_inputs():
    for label in 'xyz':
        with paropen(f'dm_ensemblebare_{label}.dat', 'w') as fd:
            fd.write('''
# DipoleMomentWriter[version=1](center=False, density='comp')
#            time            norm                    dmx                    dmy                    dmz
# Start; Time = 0.00000000
          0.00000000      -4.92017275e-16     2.055079955338e-14     2.275267093410e-14     9.816676572374e-15
# Kick = [    0.000000000000e+00,     0.000000000000e+00,     1.000000000000e-05]; Time = 0.00000000
          0.00000000      -2.56261929e-15     5.578074164489e-14     4.477138474129e-14     4.724849004460e-14
          0.41341373       3.79876430e-16    -1.137633546705e-14    -2.752339225899e-14     9.139522195897e-06
          0.82682747       1.82844350e-15    -3.229411358388e-14    -2.899130651281e-14     1.822151056685e-05
          1.24024120       2.30257796e-16     2.568849944173e-15    -1.467914253813e-15     2.719465212110e-05
          1.65365493      -1.09563085e-16     1.834892817266e-14    -3.669785634532e-16     3.601753782894e-05
          2.06706867       1.33270742e-15    -2.422058518791e-14    -3.045922076662e-14     4.466069760315e-05
          2.48048240       8.37044574e-16    -1.724799248230e-14    -2.642245656863e-14     5.310709155553e-05
          2.89389613       2.93431494e-17     5.504678451798e-15     2.568849944173e-15     6.135047097171e-05
          3.30730987       3.77197226e-16     1.100935690360e-15    -0.000000000000e+00     6.939195199957e-05
          3.72072360      -1.63710169e-16     1.431216397468e-14     6.238635578705e-15     7.723547141815e-05
          4.13413733      -4.03410565e-16     2.055079955338e-14     4.403742761439e-15     8.488299714725e-05
          4.54755107      -2.41349366e-15     6.752405567539e-14     7.596456263482e-14     9.233040644308e-05
          4.96096480       1.00069275e-15    -2.568849944173e-14    -3.449598496460e-14     9.956481323431e-05
          5.37437853      -2.31624289e-15     6.642311998503e-14     6.312031291396e-14     1.065638527118e-04
          5.78779227      -3.55273735e-15     8.697391953842e-14     8.293715534043e-14     1.132970565629e-04
          6.20120600       1.69532988e-15    -3.192713502043e-14    -3.229411358388e-14     1.197290637407e-04
          6.61461974      -2.82658143e-15     6.091844153324e-14     7.706549832518e-14     1.258240590975e-04
          7.02803347       2.57310750e-15    -4.697325612201e-14    -4.954210606619e-14     1.315505996358e-04
          7.44144720      -9.51935488e-17     7.339571269065e-16     1.137633546705e-14     1.368859163511e-04
          7.85486094       2.68573513e-15    -5.174397744691e-14    -4.844117037583e-14     1.418188643634e-04
          8.26827467       1.00204830e-15    -2.275267093410e-14    -2.568849944173e-15     1.463509522156e-04
          8.68168840       2.04459745e-15    -4.660627755856e-14    -3.743181347223e-14     1.504952279150e-04
          9.09510214      -4.46448289e-16     1.064237834014e-14     1.871590673611e-14     1.542732031233e-04
          9.50851587      -2.70445314e-15     6.789103423885e-14     6.752405567539e-14     1.577103565344e-04
          9.92192960       2.74605367e-15    -5.798261302561e-14    -6.679009854849e-14     1.608310263102e-04
    '''.strip())  # noqa: E501

def test_embeddingrr_dyadic(in_tmp_dir, write_inputs):
    """
    Testing if the dyadic is calculated correctly.
    Note, that this requires to use "extrapolate" for the interp1d function
    """
    dt, nt = 0.1, 1000
    rremission = RRemission(1e1, [0, 0, 1],
                            [2.98, 3, 0.01, 10, 5000, 3000], [1, 1, 0, 0, 0])
    dyadic_out_very_good, _ = rremission.dyadicGt(dt, nt)
    # Test that the first 30 elements of the dyadic agree with the reference
    dyadic_ref = [-0.26509844 + 1.07477307e-15j, -0.2646285 + 5.76719985e-16j,
                  -0.26482334 + 2.78241075e-16j, -0.26470851 - 2.48979644e-16j,
                  -0.26446162 - 4.63244966e-16j, -0.26435981 + 5.00200484e-16j,
                  -0.26407471 + 1.93115042e-16j, -0.26387885 - 1.57573539e-16j,
                  -0.26355268 + 7.27542009e-16j, -0.26327364 + 4.10345111e-16j,
                  -0.26289701 + 2.23836927e-16j, -0.26254291 - 1.52533693e-16j,
                  -0.26211057 - 4.12098469e-16j, -0.26168581 - 2.42895168e-16j,
                  -0.26119494 - 4.52349475e-16j, -0.26070207 + 1.01101853e-16j,
                  -0.26015115 + 4.87958740e-16j, -0.25959181 + 3.62597864e-16j,
                  -0.25898007 - 4.87213351e-16j, -0.25835544 + 2.55465137e-16j,
                  -0.25768254 + 5.68664039e-16j, -0.25699357 - 4.40321607e-16j,
                  -0.25625944 - 2.43674438e-16j, -0.2555069 + 8.38901431e-16j,
                  -0.25471166 + 5.84927072e-16j, -0.25389627 - 5.16080234e-16j,
                  -0.25304015 - 7.72222997e-16j, -0.25216259 - 3.98986399e-16j,
                  -0.25124595 + 4.53738609e-16j, -0.25030692 + 4.82469967e-16j]
    assert np.allclose(dyadic_out_very_good[:30,-1], dyadic_ref)

    """
    Test if doubling resolution = half total time for dyadic
    """
    dt, nt = 0.1, 500
    rremission = RRemission(1e1, [0, 0, 1],
                            [2.98, 3, 0.01, 10, 5000, 6000], [1, 1, 0, 0, 0])
    dyadic_out_very_good_split, _ = rremission.dyadicGt(dt, nt)
    print(dyadic_out_very_good_split[:30,-1])
    assert np.allclose(dyadic_out_very_good_split[:30,-1], dyadic_ref)


def test_embeddingrr(in_tmp_dir, write_inputs):
    cross_section = 1e-5
    dt, nt = 5, 100
    """
    Perform a short TD run to check if the full function remained consistent
    """
    d = 1.104  # N2 bondlength
    atoms = Atoms('Na2',
                  positions=[[0, 0, d / 2], [0, 0, -d / 2]],
                  cell=[10, 10, 10])
    atoms.center()
    calc = GPAW(mode='lcao', h=0.4, basis='dzp',
                setups={'Na': '1'},
                convergence={'density': 1e-12})
    atoms.calc = calc
    atoms.get_potential_energy()
    calc.write('gs.gpw', mode='all')
    td_calc = LCAOTDDFT('gs.gpw',
                        rremission=RRemission(1e-5, [0, 0, 1],
                                              [2.98, 3, 0.01, 10, 5000, 30000],
                                              [1, 1, 0, 0, 0]))
    DipoleMomentWriter(td_calc, 'dm.dat')
    td_calc.absorption_kick([0.0, 0.0, 1e-5])
    td_calc.propagate(dt, nt)

    with paropen('dm_ref.dat', 'w') as fd:
        fd.write('''
# DipoleMomentWriter[version=1](center=False, density='comp')
#            time            norm                    dmx                    dmy                    dmz
# Start; Time = 0.00000000
          0.00000000       7.88604804e-17    -4.619182583622e-15    -1.894605815478e-15    -1.210967459879e-14
# Kick = [    0.000000000000e+00,     0.000000000000e+00,     1.000000000000e-05]; Time = 0.00000000
          0.00000000       2.34993646e-17     2.794421682618e-15    -6.928648854704e-16     1.025270002303e-14
          0.20670687       7.63411792e-16    -4.437319095099e-15    -1.149357244152e-16     4.732601959920e-06
          0.41341373       5.86690218e-16    -8.658102285897e-15    -7.843800598053e-15     9.461902705969e-06
          0.62012060       1.02756794e-16     2.567092321964e-16     3.020000753053e-15     1.423036981580e-05
          0.82682747       6.32445175e-16    -7.688191462822e-15    -7.619180019881e-15     1.907395887413e-05
          1.03353433       4.90681553e-16    -7.692025431875e-15    -7.476031284070e-15     2.399863571319e-05
          1.24024120       1.25859210e-16     1.997122814050e-15     2.097847848826e-15     2.899330534015e-05
          1.44694807       6.23950472e-16    -4.029168085337e-15    -1.696781347096e-15     3.404624993473e-05
          1.65365493       3.64557711e-16    -3.782835573728e-15    -5.319507039314e-15     3.914649395281e-05
          1.86036180      -5.03436839e-16     2.324593779407e-15     2.181236675713e-15     4.428355189123e-05
          2.06706867       6.91749315e-16    -4.830092555075e-15    -5.534876083468e-15     4.944767511231e-05
          2.27377553       7.91833320e-16    -6.840384219348e-15    -7.529873545109e-15     5.462994945116e-05
          2.48048240       7.79951322e-16    -3.835427627467e-15    -9.537206385439e-15     5.982247077940e-05
          2.68718927       7.51000528e-16    -1.030650061050e-14    -1.422644225142e-14     6.501847848058e-05
          2.89389613       5.36330657e-16    -6.505745398806e-15    -9.762410393685e-15     7.021240141954e-05
          3.10060300       4.85177197e-16    -8.422979966408e-15    -1.015893447556e-14     7.539988082415e-05
          3.30730987      -1.47426757e-16    -1.659775211026e-15     1.372019164221e-15     8.057774114020e-05
          3.51401673      -1.04982353e-15     1.159054685440e-14     9.172937651896e-15     8.574391458505e-05
          3.72072360       9.51883047e-17    -1.448406830230e-15    -1.116185077134e-15     9.089731185382e-05
          3.92743047       1.24626022e-15    -1.083883887869e-14    -9.922520275194e-15     9.603764941581e-05
          4.13413733       5.29635455e-16    -3.289670467590e-15    -3.844304099294e-15     1.011652286644e-04
          4.34084420       1.08075907e-16    -4.008581338469e-15    -7.556669654898e-16     1.062806738265e-04
          4.54755107       5.11296423e-16    -6.175148915200e-15    -3.572550705925e-15     1.113846286202e-04
          4.75425793       7.52323690e-16    -8.890140760713e-15    -1.315547300496e-14     1.164774251316e-04
          4.96096480       8.85671999e-16    -5.412564135985e-15    -5.898019630442e-15     1.215587388966e-04
          5.16767167       1.49228904e-15    -1.092501983521e-14    -1.249198799103e-14     1.266272574510e-04
          5.37437853       6.30354578e-16    -3.295088032555e-15    -5.002746183157e-15     1.316803913902e-04
          5.58108540       7.83656177e-16    -1.237855251537e-14    -1.509550301899e-14     1.367140637206e-04
          5.78779227       4.66044269e-16    -1.057675375510e-15     1.516084718718e-15     1.417226033013e-04
          5.99449913       1.21281068e-16     2.674901864771e-15     1.987579564996e-15     1.466987543976e-04
          6.20120600       6.98920855e-16    -3.600346981555e-15     2.252873553983e-16     1.516337888777e-04
          6.40791287       5.58374542e-16    -9.292874205510e-15    -5.411730664452e-15     1.565176897127e-04
          6.61461974      -1.55683291e-16     2.089554807071e-15     3.326093173586e-15     1.613393618310e-04
          6.82132660       3.96869337e-16    -6.163730355196e-15    -4.427942540351e-15     1.660868326215e-04
          7.02803347       3.59714936e-16    -3.656898025076e-15    -2.647397304179e-15     1.707474167865e-04
          7.23474034       1.20751803e-16     3.196029940845e-15     1.470743867317e-15     1.753078388607e-04
          7.44144720      -9.79140193e-17    -1.687029730158e-15    -3.421942399893e-15     1.797543199932e-04
          7.64815407       2.24964075e-16     6.268539400484e-16     9.481155424838e-16     1.840726440428e-04
          7.85486094       4.79090650e-16    -4.374517015079e-15    -1.266251626670e-15     1.882482179846e-04
          8.06156780      -6.34403455e-16     7.017705288016e-15     6.071881792248e-15     1.922661401499e-04
          8.26827467       2.83421391e-16    -4.391561507931e-15    -5.000329115711e-15     1.961112842362e-04
          8.47498154       9.43864683e-16    -5.397770016273e-15    -7.779414922121e-15     1.997684042378e-04
          8.68168840      -3.66886477e-16     4.741869593295e-15     4.416065571005e-15     2.032222603317e-04
          8.88839527       1.24456657e-16    -6.697777240033e-15    -5.752620521492e-15     2.064577649382e-04
          9.09510214       1.55603901e-17     3.312257546137e-15     6.306754070277e-15     2.094601450104e-04
          9.30180900       1.21122288e-15    -1.410354687386e-14    -9.980571567475e-15     2.122151162075e-04
          9.50851587       1.39514246e-16    -2.963283015226e-15    -6.335633858899e-15     2.147090633198e-04
          9.71522274       3.01284084e-16    -1.820926931952e-15    -2.358391050074e-15     2.169292209911e-04
          9.92192960      -3.37829830e-16     1.610600390572e-15     1.950823470386e-15     2.188638483233e-04
         10.12863647      -4.35452753e-16     4.044628982276e-15     6.606053697815e-15     2.205023907668e-04
         10.33534334       1.96674863e-16    -9.630346829264e-16     1.743080690760e-15     2.218356227332e-04
         10.54205020      -4.58925655e-16     6.152061753733e-15     3.297255058541e-15     2.228557650027e-04
         10.74875707       5.34637009e-16    -7.050002309924e-15    -6.781499455534e-15     2.235565713358e-04
         10.95546394       3.84299294e-16    -3.888186375512e-15    -4.163898758664e-15     2.239333805414e-04
         11.16217080       3.20469939e-16    -1.340972349613e-15    -5.303379365148e-16     2.239831306930e-04
         11.36887767      -4.33997275e-18     2.491621474641e-15     3.482535780350e-15     2.237043350740e-04
         11.57558454       5.34901641e-16    -3.785419335481e-15     2.880519291988e-15     2.230970201960e-04
         11.78229140       6.00186475e-17    -6.854469888257e-15    -5.550503674714e-16     2.221626289649e-04
         11.98899827       9.66570150e-16    -6.058754615602e-15    -5.605262754439e-15     2.209038927679e-04
         12.19570514       1.07784811e-15    -8.095383980321e-15    -9.160560599629e-15     2.193246784789e-04
         12.40241200       9.47410758e-16    -5.746369484994e-15    -6.083508720135e-15     2.174298158363e-04
         12.60911887      -9.10071114e-17    -3.659440113252e-15     1.190614085041e-16     2.152249122160e-04
         12.81582574       6.25829363e-16    -6.113680389633e-15    -6.277832608078e-15     2.127161602464e-04
         13.02253260      -2.38407405e-16     5.582425634432e-15     5.967656177033e-15     2.099101445790e-04
         13.22923947       2.66140890e-16     3.395021269374e-15     1.268001916890e-15     2.068136523201e-04
         13.43594634       9.24916997e-16    -9.440482014023e-15    -6.701069452589e-15     2.034334919294e-04
         13.64265320       4.93618973e-16    -9.476362963523e-15    -9.679271608257e-15     1.997763241456e-04
         13.84936007       7.16704158e-16    -1.013443041249e-14    -1.398615240843e-14     1.958485080718e-04
         14.05606694      -1.20381317e-16     3.629060075870e-15     1.944489086734e-15     1.916559653097e-04
         14.26277380       5.09629239e-16    -7.410145359378e-15    -4.194278796045e-15     1.872040639435e-04
         14.46948067       1.16994021e-16     1.869893384522e-15     5.404854524304e-15     1.824975247305e-04
         14.67618754       1.07795396e-15    -1.276845049856e-14    -1.037334502745e-14     1.775403503918e-04
         14.88289440      -6.79840853e-17    -3.195821572962e-15    -2.676068724918e-15     1.723357794923e-04
         15.08960127       3.89671334e-16    -6.139934742926e-15    -4.940402512481e-15     1.668862651565e-04
         15.29630814       9.29653918e-17    -3.655272755586e-15    -6.039834811800e-15     1.611934794535e-04
         15.50301500       9.61409816e-16    -9.402225670653e-15    -6.737950567929e-15     1.552583428992e-04
         15.70972187       3.06312101e-16    -6.014038867851e-15    -6.024873997781e-15     1.490810791824e-04
         15.91642874      -4.44238552e-16     4.700612752407e-15     3.131935979949e-15     1.426612941532e-04
         16.12313560       1.71270144e-16    -9.488114912140e-15    -4.643644973119e-15     1.359980781949e-04
         16.32984247       5.37839062e-16    -6.423148369875e-15    -2.879560799725e-15     1.290901304697e-04
         16.53654934      -6.68461656e-17    -2.002623726169e-15     9.882471968028e-16     1.219359024940e-04
         16.74325620      -2.46214064e-16     6.357804201680e-15     4.619515972236e-15     1.145337580877e-04
         16.94996307      -3.12530964e-16     3.622684018642e-16    -3.531043823577e-15     1.068821455416e-04
         17.15666994       1.86936387e-16    -4.712031312410e-16     1.119185574654e-15     9.897977727712e-05
         17.36337680      -1.44753969e-17     2.426235632869e-16     2.722534762888e-16     9.082581194949e-05
         17.57008367       5.87695822e-16    -9.239407006661e-15    -6.007871178506e-15     8.242003374448e-05
         17.77679054       3.71967420e-16    -2.035837566763e-15     4.023167090299e-16     7.376302399945e-05
         17.98349740       4.53474226e-16    -4.716115322922e-15    -2.235037263175e-15     6.485632031280e-05
         18.19020427       7.01858276e-16    -4.220783190798e-15    -4.133727089165e-15     5.570255914739e-05
         18.39691114      -3.99753831e-16     2.391688237822e-15     3.195529857925e-15     4.630559792047e-05
         18.60361800       7.02969732e-16    -6.862262847092e-15    -9.708568132646e-15     3.667061349384e-05
         18.81032487      -9.70248541e-16     9.401142157660e-15     9.814752405964e-15     2.680417464451e-05
         19.01703174       7.24590206e-16    -5.019665655279e-15    -4.303588587612e-15     1.671428622259e-05
         19.22373861      -1.45944815e-16    -1.728453265354e-15    -3.735202675611e-16     6.410404468690e-06
         19.43044547       5.44613653e-17    -9.549083354786e-16    -1.977744600905e-15    -4.096577613973e-06
         19.63715234       5.96905032e-16    -7.065963289783e-15    -6.497452357052e-15    -1.479437378926e-05
         19.84385921       2.35575838e-16    -5.374016077579e-15    -6.222448424703e-15    -2.566937633914e-05
         20.05056607       4.11185955e-16    -6.758954050563e-15    -5.961363466958e-15    -3.670675403685e-05
         20.25727294       9.16686927e-17    -6.805920171454e-15    -5.722657219877e-15    -4.789057380467e-05
         20.46397981      -1.07123230e-16     1.796714583915e-15    -2.236454164781e-15    -5.920394325650e-05
         20.67068667      -3.80065174e-16     4.622099733988e-15     5.246369912284e-15    -7.062917036676e-05
'''.strip())  # noqa: E501

    check_txt_data('dm.dat', 'dm_ref.dat', atol=1e-8)

    """
    Run in 2 splits, check if restart still works.
    IMPORTANT: The simple convolution implemented at the moment is
    heavility dependent on the time-steppin dt. With the large dt used here,
    the deviation between full run and restarted is quite large. If you reduce
    dt to a more reasonable value and add more steps, the error goes quickly
    down. I tried with 0.1 spacing and same total time and the error at the end
    was on the order of 1e-7, which seems alright for this method.
    """

    td_calc = LCAOTDDFT('gs.gpw',
                        rremission=RRemission(cross_section, [0, 0, 1],
                                              [2.98, 3, 0.01, 10, 5000, 60000],
                                              [1, 1, 0, 0, 0]))
    DipoleMomentWriter(td_calc, 'dm_split.dat')
    td_calc.absorption_kick([0.0, 0.0, 1e-5])
    td_calc.propagate(dt, int(nt * 0.5))
    td_calc.write('td_split0.gpw', mode='all')
    td_calc_restart = LCAOTDDFT('td_split0.gpw')
    DipoleMomentWriter(td_calc_restart, 'dm_split.dat')
    td_calc_restart.propagate(dt, int(nt * 0.5))
    td_calc_restart.write('td_split1.gpw', mode='all')

    with paropen('dm_ref_restart.dat', 'w') as fd:
        fd.write('''
# DipoleMomentWriter[version=1](center=False, density='comp')
#            time            norm                    dmx                    dmy                    dmz
# Start; Time = 0.00000000
          0.00000000       7.88604804e-17    -4.619182583622e-15    -1.894605815478e-15    -1.210967459879e-14
# Kick = [    0.000000000000e+00,     0.000000000000e+00,     1.000000000000e-05]; Time = 0.00000000
          0.00000000       2.34993646e-17     2.794421682618e-15    -6.928648854704e-16     1.025270002303e-14
          0.20670687       8.31713436e-16    -5.503162491634e-15    -1.145314907217e-15     4.732577261482e-06
          0.41341373       4.99493815e-16     1.546089693910e-16    -2.703239896897e-15     9.461878119021e-06
          0.62012060       1.28010672e-15    -1.243827075072e-14    -1.364851309036e-14     1.423054242553e-05
          0.82682747       6.92463822e-16    -5.811338590999e-15    -6.450277868278e-15     1.907472288159e-05
          1.03353433       2.71936341e-16    -5.050837490617e-16     1.207783598623e-15     2.400058604918e-05
          1.24024120      -3.16712158e-16     2.628394153224e-15     2.701406259524e-15     2.899724427112e-05
          1.44694807       8.97818630e-16    -5.030500785210e-15    -6.784791668090e-15     3.405319411702e-05
          1.65365493       5.99127945e-16    -6.340801382404e-15    -8.210403051889e-15     3.915768071042e-05
          1.86036180       8.92499518e-16    -7.410687115875e-15    -4.917440371744e-15     4.430044458966e-05
          2.06706867      -8.81332027e-16     1.704199243740e-15     4.785543501630e-15     4.947196774222e-05
          2.27377553       8.93928533e-16    -1.333650302195e-14    -1.070269130376e-14     5.466357022383e-05
          2.48048240       1.07266131e-15    -1.055262475422e-14    -9.011744257393e-15     5.986758521259e-05
          2.68718927      -2.81965912e-16    -6.844884965626e-16    -2.977160316252e-16     6.507749154740e-05
          2.89389613       1.86036637e-17     6.227949336822e-15     8.365720472083e-15     7.028795909920e-05
          3.10060300       9.10335747e-16    -9.818044618519e-15    -1.282504321566e-14     7.549487112699e-05
          3.30730987       1.45812499e-15    -1.598285848671e-14    -1.128666313343e-14     8.069529465476e-05
          3.51401673      -4.01473942e-16     2.353265200146e-15    -7.850051634551e-16     8.588740462069e-05
          3.72072360       1.12619646e-15    -1.290255606824e-15    -1.865350964666e-15     9.107035427497e-05
          3.92743047       4.25052697e-16     2.647522324909e-15    -1.199032147525e-15     9.624410231891e-05
          4.13413733       9.48178192e-16    -9.360302052538e-15    -4.937360341385e-15     1.014091918961e-04
          4.34084420       6.18525506e-16    -4.564131788861e-15    -4.114557243904e-15     1.065664885568e-04
          4.54755107      -1.00756172e-15     7.194734641647e-15     4.099346388425e-15     1.117168767962e-04
          4.75425793      -3.32907666e-17     1.041756069228e-15    -9.634097451163e-16     1.168609290279e-04
          4.96096480       2.73603526e-16    -4.736035292564e-15    -4.453655137148e-15     1.219985607459e-04
          5.16767167       4.68425961e-16    -6.389684487821e-15    -3.286836664377e-15     1.271286990367e-04
          5.37437853       1.04386930e-15    -8.975613266433e-15    -9.493199088492e-15     1.322489936249e-04
          5.58108540       9.20285928e-16    -1.368776959957e-14    -1.417847596469e-14     1.373556062031e-04
          5.78779227       8.10251741e-16    -2.010124969966e-15    -1.355974837209e-15     1.424431035360e-04
          5.99449913       6.75024542e-16    -6.113722063210e-15    -6.501327999680e-15     1.475044667418e-04
          6.20120600       5.75390411e-16    -2.259916388438e-15    -3.380685559005e-15     1.525312030841e-04
          6.40791287       2.75614733e-16    -3.270959031671e-15    -7.214946326325e-15     1.575135287464e-04
          6.61461974       5.41014651e-16    -5.582258940125e-15    -4.806380289958e-15     1.624405790093e-04
          6.82132660       1.00525942e-15    -9.861260117511e-15    -1.050069947771e-14     1.673006079716e-04
          7.02803347      -2.76249851e-16     3.171567551349e-15     5.323049293330e-15     1.720811523411e-04
          7.23474034       1.26586949e-15    -8.444275164079e-15    -7.204194543548e-15     1.767691529230e-04
          7.44144720       1.41684232e-16     3.004706550421e-15     1.353599443339e-15     1.813510404398e-04
          7.64815407       4.46805487e-16    -1.012555394066e-14    -5.443444256287e-15     1.858128002541e-04
          7.85486094       6.19584036e-16    -4.315007147616e-15    -2.434653695354e-15     1.901400317007e-04
          8.06156780      -2.89243306e-16     6.743034744281e-15     9.162144195542e-15     1.943180149753e-04
          8.26827467      -3.73528752e-16     3.374892931850e-15     2.343221868172e-15     1.983317938889e-04
          8.47498154      -4.40216138e-16     1.942238713595e-15     2.209408013532e-15     2.021662793291e-04
          8.68168840       4.67658527e-16    -2.273918710194e-15    -4.431568141520e-15     2.058063739139e-04
          8.88839527      -5.27941807e-17     6.531666363485e-15     4.863389742822e-15     2.092371165996e-04
          9.09510214       3.75407643e-16    -8.396850633845e-15    -3.281335752259e-15     2.124438434996e-04
          9.30180900       5.64699259e-16    -3.997662861386e-15    -4.380893072308e-15     2.154123607875e-04
          9.50851587       1.05998542e-15    -6.832341219053e-15    -5.662647269493e-15     2.181291235967e-04
          9.71522274      -4.70410705e-16     3.010707545459e-15     2.251915061720e-15     2.205814156279e-04
          9.92192960       2.70163304e-16    -1.686487973662e-15    -1.455741379722e-15     2.227575221944e-04
         10.12863647      -1.56106703e-16    -8.279706209867e-16     6.327715879335e-16     2.246468911541e-04
         10.33534334       4.56993838e-16    -1.601348856555e-15     7.100343990523e-16     2.262402742194e-04
# Start; Time = 10.33534334
         10.33534334      -1.73281351e-16     4.769749216078e-15     5.509163486672e-15     2.262402742252e-04
         10.54205020       1.25488724e-16     3.433902716393e-17     3.602263966081e-16     2.275147191194e-04
         10.74875707       4.60460523e-17     2.731494581869e-15     2.946988646753e-15     2.284487375677e-04
         10.95546394       1.57324012e-16    -5.356971584727e-15    -9.461485496657e-15     2.290421975216e-04
         11.16217080       2.43117864e-16    -1.520835506457e-15    -1.065968417265e-15     2.293018431626e-04
         11.36887767       2.58387158e-16    -2.921734459300e-15    -6.228282725435e-15     2.292317016595e-04
         11.57558454       5.91956405e-16    -1.773794116754e-15    -1.561925653039e-16     2.288318717628e-04
         11.78229140       4.49054863e-16    -2.826593683796e-15    -3.377935102945e-15     2.281034697298e-04
         11.98899827       6.23871082e-16    -5.581967225089e-15    -6.388684321981e-15     2.270490349809e-04
         12.19570514       5.04336589e-16    -1.572469067933e-15    -2.254957232816e-15     2.256722009324e-04
         12.40241200      -4.56993838e-16     4.530667906807e-15     4.543586715570e-15     2.239775622493e-04
         12.60911887       5.18441501e-16    -8.222155000506e-15    -6.191776672285e-15     2.219704521667e-04
         12.81582574       6.32736271e-16    -6.486492206391e-15    -6.512329823917e-15     2.196567524362e-04
         13.02253260       3.91391445e-16    -3.504706123131e-15    -1.787421376321e-15     2.170427168767e-04
         13.22923947      -2.75138394e-16     4.883726448230e-16    -1.537963346462e-15     2.141347772726e-04
         13.43594634       2.07260162e-16    -4.399729528956e-15    -3.996287633356e-15     2.109393676228e-04
         13.64265320       8.57991442e-16    -1.004012310852e-14    -8.538915856663e-15     2.074627592637e-04
         13.84936007      -2.24990538e-16    -1.665651185334e-15    -1.480287116371e-15     2.037109148085e-04
         14.05606694      -5.47180588e-16     2.225619034851e-15     4.581176281713e-15     1.996893577223e-04
         14.26277380       4.56438109e-16    -1.898856520297e-15    -5.584134251075e-15     1.954030654619e-04
         14.46948067      -7.52403080e-16     4.898020485023e-15     8.984031328918e-15     1.908563840384e-04
         14.67618754       8.55953771e-16    -1.031704402539e-14    -8.957860322778e-15     1.860529681673e-04
         14.88289440      -2.75111931e-16    -2.005999285878e-15    -3.735619411377e-15     1.809957436886e-04
         15.08960127       8.22689468e-16    -1.270227285883e-14    -8.592716444125e-15     1.756868926633e-04
         15.29630814       5.45698646e-16    -3.405648031421e-15     3.702697285820e-16     1.701278574592e-04
         15.50301500       5.48927163e-16    -4.656813823342e-15    -2.926193532002e-15     1.643193625839e-04
         15.70972187       1.98103878e-16    -4.856013519754e-15     2.761707924944e-16     1.582614517902e-04
         15.91642874       5.31302639e-16    -5.708863266004e-15    -4.214448807146e-15     1.519535427272e-04
         16.12313560       7.89451628e-16    -6.070506564218e-15    -6.535000249618e-15     1.453945021082e-04
         16.32984247       7.96676095e-16    -9.500700332289e-15    -8.881806045382e-15     1.385827479737e-04
         16.53654934      -4.04252583e-16     2.592304835840e-15     1.120394108377e-15     1.315163823629e-04
         16.74325620      -5.24395731e-16     6.257287534787e-15     9.246449841116e-15     1.241933547719e-04
         16.94996307      -2.82257008e-16     2.573009969849e-15     4.717157162339e-15     1.166116503252e-04
         17.15666994       5.51176539e-16    -2.412274984690e-15    -5.646311227445e-15     1.087694934663e-04
         17.36337680       3.78397990e-16    -2.327052520430e-15    -4.166357499686e-15     1.006655555452e-04
         17.57008367       4.10444984e-16    -3.951196823415e-15    -3.319342054168e-15     9.229915692892e-05
         17.77679054       2.63944440e-16    -3.498413413056e-15    -2.800381004080e-15     8.367045538067e-05
         17.98349740      -3.32484254e-16     5.083509574715e-15     7.238033487792e-15     7.478061617550e-05
         18.19020427       8.39414241e-16    -5.342969262971e-16    -7.297876743869e-16     6.563195967034e-05
         18.39691114       1.31212725e-15    -1.174740619693e-14    -1.262888569034e-14     5.622808476827e-05
         18.60361800      -4.34367760e-16     4.393811881071e-15     6.976698488587e-15     4.657396545312e-05
         18.81032487       6.26887893e-16    -5.577133090197e-15    -5.573007406108e-15     3.667601931243e-05
         19.01703174       1.05048511e-15    -8.275663872931e-15    -6.109137969778e-15     2.654214691703e-05
         19.22373861       2.26684186e-16    -2.570217840213e-15    -4.007081089710e-15     1.618174120197e-05
         19.43044547       8.85036881e-16    -1.025203324581e-14    -7.346968217169e-15     5.605666865759e-06
         19.63715234      -3.80118101e-16     4.601971396464e-15     3.730951970792e-15    -5.173789208206e-06
         19.84385921       5.68589356e-16    -4.552421513821e-15    -4.334260340030e-15    -1.614299563804e-05
         20.05056607       5.30005940e-16    -4.802046237986e-15    -7.165188075799e-15    -2.728707972555e-05
         20.25727294       6.50413721e-16     1.347431753995e-15     6.516080445816e-16    -3.859005393876e-05
         20.46397981       6.00027696e-16    -3.861932022220e-15    -4.408314285747e-15    -5.003496210897e-05
         20.67068667       1.06538392e-15    -7.770621797446e-15    -8.818628903173e-15    -6.160404200414e-05
'''.strip())  # noqa: E501

    check_txt_data('dm_split.dat', 'dm_ref_restart.dat', atol=1e-8)
